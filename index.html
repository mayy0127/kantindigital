<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kantin Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* putih */
            background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/dark-food.png');
            background-repeat: repeat;
        }
        .login-bg {
             background-color: #ffffff; /* putih */
             background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/dark-food.png');
             background-repeat: repeat;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden {
            display: none;
        }
        /* Custom scrollbar for payment methods */
        #payment-methods::-webkit-scrollbar {
            height: 4px;
        }
        #payment-methods::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 20px;
        }
        .btn-primary {
            @apply w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none;
        }
        .btn-secondary {
             @apply bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors;
        }
        .card {
            @apply bg-white rounded-xl shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
        }
        .input-field {
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 login-bg">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <div class="flex flex-col items-center mb-6">
                <div class="bg-blue-600 p-3 rounded-full mb-3">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-center text-gray-800">Kantin Digital</h2>
            </div>
            <div id="login-error" class="text-red-500 text-center mb-4 text-sm"></div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 mb-2 font-medium">Username</label>
                    <input type="text" id="username" class="input-field" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 mb-2 font-medium">Password</label>
                    <input type="password" id="password" class="input-field" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-0.5">Login</button>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                Belum punya akun? <a href="#" id="show-register-link" class="font-semibold text-blue-600 hover:underline">Daftar di sini</a>
            </p>
            <div class="mt-4 text-xs text-gray-500 text-center space-y-1 p-3 bg-gray-50 rounded-lg">
                <p><span class="font-semibold">Admin:</span> admin123 / admin123</p>
                <p><span class="font-semibold">Penjual:</span> penjual123 / penjual123</p>
            </div>
        </div>
    </div>
    
    <!-- Register Screen -->
    <div id="register-screen" class="hidden min-h-screen flex items-center justify-center p-4 login-bg">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Daftar Akun Baru</h2>
            <div id="register-error" class="text-red-500 text-center mb-4 text-sm"></div>
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-name" class="block text-gray-700 mb-2 font-medium">Nama Lengkap</label>
                    <input type="text" id="register-name" class="input-field" required>
                </div>
                <div class="mb-4">
                    <label for="register-username" class="block text-gray-700 mb-2 font-medium">Username</label>
                    <input type="text" id="register-username" class="input-field" required>
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block text-gray-700 mb-2 font-medium">Password</label>
                    <input type="password" id="register-password" class="input-field" required>
                </div>
                <div class="mb-6">
                    <label for="register-confirm-password" class="block text-gray-700 mb-2 font-medium">Konfirmasi Password</label>
                    <input type="password" id="register-confirm-password" class="input-field" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 transform hover:-translate-y-0.5">Daftar</button>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                Sudah punya akun? <a href="#" id="show-login-link" class="font-semibold text-blue-600 hover:underline">Login di sini</a>
            </p>
        </div>
    </div>


    <!-- App Screen -->
    <div id="app-screen" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <!-- Header -->
            <header class="bg-white rounded-xl shadow-md p-4 mb-8 flex justify-between items-center border border-gray-100">
                <div class="flex items-center gap-4">
                     <div class="bg-blue-600 p-3 rounded-full">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Kantin Digital</h1>
                        <p id="header-subtitle" class="text-gray-600 text-sm">Selamat datang!</p>
                    </div>
                </div>
                <button id="logout-button" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition-colors shadow-sm hover:shadow-md">Logout</button>
            </header>

            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Admin</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Laporan Profit (10%)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                        <div>
                            <p class="text-gray-500 text-sm">Total Penjualan</p>
                            <p id="admin-total-sales" class="text-3xl font-bold text-gray-800">Rp 0</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Total Profit</p>
                            <p id="admin-total-profit" class="text-3xl font-bold text-green-600">Rp 0</p>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Semua Produk Penjual</h3>
                <div id="admin-product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Admin product view injected here -->
                </div>

                <div class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-700">Pengelola Penjual</h3>
                        <button id="add-seller-button" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">+ Tambah Penjual</button>
                    </div>
                    <div id="admin-seller-list" class="card overflow-hidden">
                        <!-- Seller list table will be injected here -->
                    </div>
                </div>

                <div class="mt-12">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Pengguna Terdaftar</h3>
                    <div id="admin-user-list" class="card overflow-hidden">
                        <!-- User list table will be injected here -->
                    </div>
                </div>
                
                <div class="mt-12">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Laporan Transaksi</h3>
                     <div class="card p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                            <div>
                                <p class="text-gray-500 text-sm">Total Transaksi Selesai</p>
                                <p id="admin-total-transactions" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Total Uang Masuk</p>
                                <p id="admin-total-revenue" class="text-3xl font-bold text-blue-700">Rp 0</p>
                            </div>
                        </div>
                    </div>
                    <div id="admin-transaction-list" class="card overflow-hidden">
                        <!-- Transaction list table will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Main Content for Users and Sellers -->
            <main id="main-content" class="flex flex-col lg:flex-row gap-8">
                <!-- Menu/Products Section -->
                <div class="w-full lg:w-2/3">
                    <div id="seller-dashboard" class="hidden mb-8">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Dashboard Penjual</h2>
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4">Pesanan Masuk</h3>
                            <div id="seller-orders-container" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Seller orders injected here -->
                            </div>
                        </div>
                        <div class="card p-6 mt-8">
                            <h3 class="text-xl font-semibold mb-4">Laporan Transaksi Selesai</h3>
                            <div id="seller-transaction-list" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Seller transaction list injected here -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 id="menu-title" class="text-2xl font-semibold text-gray-700">Menu Makanan</h2>
                        <button id="add-menu-button" class="hidden bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600 transition-colors shadow-sm">+ Tambah Menu</button>
                    </div>
                    <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Menu items will be injected here -->
                    </div>
                </div>

                <!-- Cart & User Orders Section -->
                <div id="cart-and-orders-section" class="w-full lg:w-1/3">
                    <div class="card p-6 sticky top-8">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">Keranjang Anda</h2>
                        <div id="cart-items-container" class="space-y-4 mb-4 max-h-80 overflow-y-auto pr-2"></div>
                        <div class="border-t pt-4 space-y-4">
                            <div>
                                <h3 class="text-md font-semibold text-gray-700 mb-3">Metode Pembayaran</h3>
                                <div class="flex overflow-x-auto gap-2 pb-2" id="payment-methods">
                                    <button data-payment="tunai" class="payment-method-btn flex-shrink-0 px-4 border-2 border-blue-600 bg-blue-50 text-blue-800 font-semibold py-2 rounded-lg text-sm">Tunai</button>
                                    <button data-payment="qris" class="payment-method-btn flex-shrink-0 px-4 border-2 border-gray-300 bg-white text-gray-800 font-semibold py-2 rounded-lg text-sm">QRIS</button>
                                    <button data-payment="dana" class="payment-method-btn flex-shrink-0 px-4 border-2 border-gray-300 bg-white text-gray-800 font-semibold py-2 rounded-lg text-sm">DANA</button>
                                    <button data-payment="ovo" class="payment-method-btn flex-shrink-0 px-4 border-2 border-gray-300 bg-white text-gray-800 font-semibold py-2 rounded-lg text-sm">OVO</button>
                                    <button data-payment="gopay" class="payment-method-btn flex-shrink-0 px-4 border-2 border-gray-300 bg-white text-gray-800 font-semibold py-2 rounded-lg text-sm">GoPay</button>
                                    <button data-payment="kartu" class="payment-method-btn flex-shrink-0 px-4 border-2 border-gray-300 bg-white text-gray-800 font-semibold py-2 rounded-lg text-sm">Kartu</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-lg font-semibold text-gray-800 pt-2">
                                <span>Total</span>
                                <span id="cart-total" class="text-xl text-blue-700">Rp 0</span>
                            </div>
                            <button id="order-button" class="btn-primary">
                                Pesan Sekarang
                            </button>
                        </div>
                        <div id="order-status" class="mt-4 text-center"></div>
                    </div>

                    <!-- User's Orders Section -->
                    <div id="user-orders-section" class="mt-8">
                        <div class="card p-6">
                            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">Riwayat Pesanan Saya</h2>
                            <div id="user-orders-container" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- User's orders will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal for Add/Edit Menu -->
    <div id="menu-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Tambah Menu Baru</h2>
            <form id="menu-form">
                <input type="hidden" id="menu-id">
                <div class="mb-4">
                    <label for="menu-name" class="block text-gray-700 mb-1 font-medium">Nama Menu</label>
                    <input type="text" id="menu-name" class="input-field" required>
                </div>
                <div class="mb-4">
                    <label for="menu-price" class="block text-gray-700 mb-1 font-medium">Harga</label>
                    <input type="number" id="menu-price" class="input-field" min="0" required>
                </div>
                <div class="mb-4">
                    <label for="menu-stock" class="block text-gray-700 mb-1 font-medium">Stok Makanan</label>
                    <input type="number" id="menu-stock" class="input-field" min="0" required>
                </div>
                <div class="mb-4">
                    <label for="menu-image-upload" class="block text-gray-700 mb-1 font-medium">Gambar Makanan</label>
                    <img id="image-preview" src="" alt="Preview Gambar" class="w-full h-40 object-cover rounded-lg mb-2 border hidden">
                    <input type="file" id="menu-image-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*">
                    <input type="hidden" id="menu-image-data">
                </div>
                <div id="modal-error" class="text-red-500 text-sm -mt-2 mb-4 hidden"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-modal" class="btn-secondary">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Add/Edit Seller -->
    <div id="seller-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h2 id="seller-modal-title" class="text-2xl font-bold mb-4">Tambah Penjual Baru</h2>
            <form id="seller-form">
                <input type="hidden" id="seller-id-input">
                <div class="mb-4">
                    <label for="seller-name" class="block text-gray-700 mb-1 font-medium">Nama Penjual</label>
                    <input type="text" id="seller-name" class="input-field" required>
                </div>
                <div class="mb-4">
                    <label for="seller-username" class="block text-gray-700 mb-1 font-medium">Username</label>
                    <input type="text" id="seller-username" class="input-field" required>
                </div>
                <div class="mb-4">
                    <label for="seller-password" class="block text-gray-700 mb-1 font-medium">Password</label>
                    <input type="text" id="seller-password" class="input-field" required>
                </div>
                <div id="seller-modal-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-seller-modal" class="btn-secondary">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for QRIS Payment -->
    <div id="qris-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm text-center">
            <h2 id="qris-modal-title" class="text-2xl font-bold mb-4">Pembayaran QRIS</h2>
            <p class="text-gray-600 mb-4">Silakan scan kode di bawah ini untuk membayar.</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://example.com/kantin-digital" alt="QRIS Code" class="mx-auto rounded-lg">
            <p class="font-bold text-2xl my-4 text-blue-700" id="qris-total"></p>
            <button id="close-qris-modal" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700">Tutup</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let sellers = [
            { id: 'seller01', name: 'Kantin Bu Ani', username: 'penjual123', password: 'penjual123' }
        ];
        
        let users = [
            { id: 'user01', name: 'Siswa Cerdas', username: 'user123', password: 'user123' }
        ];

        let menuItems = [
            { id: 1, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Nasi Goreng Spesial', price: 25000, stock: 15, image: 'https://placehold.co/600x400/f8b4b4/333?text=Nasi+Goreng' },
            { id: 2, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Mie Ayam Bakso', price: 18000, stock: 20, image: 'https://placehold.co/600x400/a2d2ff/333?text=Mie+Ayam' },
            { id: 3, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Sate Ayam (10 tusuk)', price: 22000, stock: 30, image: 'https://placehold.co/600x400/ffc8dd/333?text=Sate+Ayam' },
            { id: 4, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Gado-gado', price: 15000, stock: 10, image: 'https://placehold.co/600x400/cdb4db/333?text=Gado-Gado' },
            { id: 5, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Ayam Geprek', price: 20000, stock: 0, image: 'https://placehold.co/600x400/bde0fe/333?text=Ayam+Geprek' },
            { id: 6, sellerId: 'seller01', sellerName: 'Kantin Bu Ani', name: 'Es Teh Manis', price: 5000, stock: 50, image: 'https://placehold.co/600x400/e9edc9/333?text=Es+Teh' }
        ];
        let orders = [];

        // --- ACCOUNTS (Dynamically generated) ---
        let accounts = {};
        const generateAccounts = () => {
            accounts = {
                admin123: { password: 'admin123', role: 'admin', id: 'admin01', name: 'Admin Sekolah' },
            };
            sellers.forEach(seller => {
                accounts[seller.username] = { password: seller.password, role: 'penjual', id: seller.id, name: seller.name };
            });
            users.forEach(user => {
                accounts[user.username] = { password: user.password, role: 'user', id: user.id, name: user.name };
            });
        };

        // --- STATE ---
        let cart = [];
        let currentUser = null;
        let selectedPaymentMethod = 'tunai';
        const qrisMethods = ['qris', 'dana', 'ovo', 'gopay'];

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const headerSubtitle = document.getElementById('header-subtitle');
        
        const registerScreen = document.getElementById('register-screen');
        const registerForm = document.getElementById('register-form');
        const registerError = document.getElementById('register-error');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');

        const adminDashboard = document.getElementById('admin-dashboard');
        const adminTotalSales = document.getElementById('admin-total-sales');
        const adminTotalProfit = document.getElementById('admin-total-profit');
        const adminProductList = document.getElementById('admin-product-list');
        const adminSellerList = document.getElementById('admin-seller-list');
        const adminUserList = document.getElementById('admin-user-list');
        const adminTransactionList = document.getElementById('admin-transaction-list');
        const adminTotalTransactions = document.getElementById('admin-total-transactions');
        const adminTotalRevenue = document.getElementById('admin-total-revenue');

        const mainContent = document.getElementById('main-content');
        const sellerDashboard = document.getElementById('seller-dashboard');
        const sellerOrdersContainer = document.getElementById('seller-orders-container');
        const sellerTransactionList = document.getElementById('seller-transaction-list');
        
        const menuTitle = document.getElementById('menu-title');
        const addMenuButton = document.getElementById('add-menu-button');
        const menuContainer = document.getElementById('menu-container');
        
        const cartAndOrdersSection = document.getElementById('cart-and-orders-section');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalElement = document.getElementById('cart-total');
        const orderButton = document.getElementById('order-button');
        const orderStatus = document.getElementById('order-status');
        const paymentMethodsContainer = document.getElementById('payment-methods');
        const userOrdersSection = document.getElementById('user-orders-section');
        const userOrdersContainer = document.getElementById('user-orders-container');
        
        const menuModal = document.getElementById('menu-modal');
        const menuForm = document.getElementById('menu-form');
        const cancelModalButton = document.getElementById('cancel-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalError = document.getElementById('modal-error');
        const imagePreview = document.getElementById('image-preview');
        const menuImageUpload = document.getElementById('menu-image-upload');
        const menuImageData = document.getElementById('menu-image-data');
        
        const sellerModal = document.getElementById('seller-modal');
        const sellerModalTitle = document.getElementById('seller-modal-title');
        const sellerForm = document.getElementById('seller-form');
        const addSellerButton = document.getElementById('add-seller-button');
        const cancelSellerModalButton = document.getElementById('cancel-seller-modal');
        const sellerModalError = document.getElementById('seller-modal-error');
        
        const qrisModal = document.getElementById('qris-modal');
        const qrisModalTitle = document.getElementById('qris-modal-title');
        const qrisTotalElement = document.getElementById('qris-total');
        const closeQrisModalButton = document.getElementById('close-qris-modal');

        // --- HELPER FUNCTION ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

        // --- RENDER FUNCTIONS ---
        const renderMenu = () => {
            menuContainer.innerHTML = '';
            let itemsToDisplay = [];

            if (currentUser.role === 'penjual') {
                itemsToDisplay = menuItems.filter(item => item.sellerId === currentUser.id);
            } else { // User and Admin see all
                itemsToDisplay = menuItems;
            }

            if (itemsToDisplay.length === 0 && currentUser.role === 'penjual') {
                menuContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Anda belum memiliki produk. Silakan tambahkan menu.</p>';
            }

            itemsToDisplay.forEach(item => {
                const isSeller = currentUser.role === 'penjual';
                const isOutOfStock = item.stock === 0;
                const menuItemElement = document.createElement('div');
                menuItemElement.className = `card flex flex-col relative ${isOutOfStock ? 'opacity-60' : ''}`;
                menuItemElement.innerHTML = `
                    ${isOutOfStock ? `<div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10 rounded-xl"><span class="text-white text-xl font-bold">STOK HABIS</span></div>` : ''}
                    <img src="${item.image}" alt="${item.name}" class="w-full h-48 object-cover rounded-t-xl" onerror="this.src='https://placehold.co/600x400/cccccc/333?text=Gambar+Error'">
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                        ${currentUser.role !== 'penjual' ? `<p class="text-xs text-gray-500 mb-1">dari ${item.sellerName}</p>` : ''}
                        <div class="flex justify-between items-center mt-1 mb-4">
                            <p class="text-blue-700 font-bold text-lg">${formatRupiah(item.price)}</p>
                            <p class="text-sm font-medium ${item.stock < 5 ? 'text-red-500' : 'text-gray-500'}">Stok: ${item.stock}</p>
                        </div>
                        <div class="mt-auto">
                            ${isSeller ? `
                                <div class="flex gap-2">
                                    <button onclick="handleEditMenu(${item.id})" class="w-full bg-yellow-500 text-white font-semibold py-2 rounded-lg hover:bg-yellow-600 transition-colors">Edit</button>
                                    <button onclick="handleDeleteMenu(${item.id})" class="w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition-colors">Hapus</button>
                                </div>
                            ` : `
                                <button onclick="addToCart(${item.id})" class="w-full bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    + Tambah ke Keranjang
                                </button>
                            `}
                        </div>
                    </div>
                `;
                menuContainer.appendChild(menuItemElement);
                 // Disable button after creating it
                if (!isSeller) {
                    menuItemElement.querySelector('button').disabled = isOutOfStock;
                }
            });
        };

        const renderCart = () => {
            if (currentUser.role !== 'user') return;
            cartItemsContainer.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Keranjang Anda kosong.</p>';
            } else {
                cart.forEach(cartItem => {
                    total += cartItem.price * cartItem.quantity;
                    const cartItemElement = document.createElement('div');
                    cartItemElement.className = 'flex justify-between items-center fade-in';
                    cartItemElement.innerHTML = `
                        <div class="flex-grow pr-2">
                            <p class="font-semibold text-gray-800 truncate">${cartItem.name}</p>
                            <p class="text-sm text-gray-500">${formatRupiah(cartItem.price)}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <button onclick="updateQuantity(${cartItem.id}, -1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold text-gray-700 hover:bg-gray-300 transition-colors">-</button>
                            <span class="w-8 text-center font-semibold">${cartItem.quantity}</span>
                            <button onclick="updateQuantity(${cartItem.id}, 1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold text-gray-700 hover:bg-gray-300 transition-colors">+</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemElement);
                });
            }
            cartTotalElement.textContent = formatRupiah(total);
            orderButton.disabled = cart.length === 0;
        };

        const renderSellerOrders = () => {
            sellerOrdersContainer.innerHTML = '';
            const myOrders = orders.filter(order => order.sellerId === currentUser.id);

            if (myOrders.length === 0) {
                 sellerOrdersContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada pesanan masuk.</p>';
                 return;
            }

            myOrders.sort((a, b) => b.id - a.id).forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'border rounded-lg p-4 bg-gray-50';
                const itemsHtml = order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('');
                const statusColor = {
                    'Baru': 'bg-blue-100 text-blue-800',
                    'Diproses': 'bg-yellow-100 text-yellow-800',
                    'Siap Diambil': 'bg-indigo-100 text-indigo-800',
                    'Selesai': 'bg-green-100 text-green-800'
                }[order.status];

                orderCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">Pesanan #${order.id} <span class="text-sm font-normal text-gray-600">dari ${order.buyerName}</span></p>
                            <p class="font-semibold text-lg text-blue-700">${formatRupiah(order.total)}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${order.status}</span>
                    </div>
                    <ul class="list-disc list-inside text-sm text-gray-700 my-2">
                        ${itemsHtml}
                    </ul>
                    ${order.status === 'Baru' ? `<button onclick="updateOrderStatus(${order.id}, 'Diproses')" class="w-full text-sm bg-yellow-500 text-white font-semibold py-1 rounded-lg hover:bg-yellow-600 mt-2 transition-colors">Proses Pesanan</button>` : ''}
                    ${order.status === 'Diproses' ? `<button onclick="updateOrderStatus(${order.id}, 'Siap Diambil')" class="w-full text-sm bg-indigo-500 text-white font-semibold py-1 rounded-lg hover:bg-indigo-600 mt-2 transition-colors">Tandai Siap Diambil</button>` : ''}
                `;
                sellerOrdersContainer.appendChild(orderCard);
            });
        };

        const renderUserOrders = () => {
            if (currentUser.role !== 'user') return;
            userOrdersContainer.innerHTML = '';
            const myOrders = orders.filter(order => order.buyerId === currentUser.id);

            if (myOrders.length === 0) {
                userOrdersContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Anda belum pernah memesan.</p>';
                return;
            }

            myOrders.sort((a, b) => b.id - a.id).forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'border rounded-lg p-4 bg-gray-50 fade-in';
                const sellerName = sellers.find(s => s.id === order.sellerId)?.name || 'Penjual Terhapus';
                const itemsHtml = order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('');
                const statusColor = {
                    'Baru': 'bg-blue-100 text-blue-800',
                    'Diproses': 'bg-yellow-100 text-yellow-800',
                    'Siap Diambil': 'bg-indigo-100 text-indigo-800',
                    'Selesai': 'bg-green-100 text-green-800'
                }[order.status];

                orderCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">Pesanan #${order.id} <span class="text-sm font-normal text-gray-600">dari ${sellerName}</span></p>
                            <p class="font-semibold text-lg text-blue-700">${formatRupiah(order.total)}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${order.status}</span>
                    </div>
                    <ul class="list-disc list-inside text-sm text-gray-700 my-2">
                        ${itemsHtml}
                    </ul>
                    ${order.status === 'Siap Diambil' ? `<button onclick="updateOrderStatus(${order.id}, 'Selesai')" class="w-full text-sm bg-green-500 text-white font-semibold py-1 rounded-lg hover:bg-green-600 mt-2 transition-colors">Konfirmasi Sudah Diambil</button>` : ''}
                `;
                userOrdersContainer.appendChild(orderCard);
            });
        };

        const renderAdminUserList = () => {
            adminUserList.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr class="border-b">
                            <th class="p-4 font-semibold text-sm text-gray-600">Nama Lengkap</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Username</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr class="border-b last:border-b-0 hover:bg-slate-50 transition-colors">
                                <td class="p-4">${user.name}</td>
                                <td class="p-4 font-mono text-sm">${user.username}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            if (users.length === 0) {
                 adminUserList.innerHTML = '<p class="text-gray-500 text-center p-4">Belum ada pengguna terdaftar.</p>';
            }
        };

        const renderAdminSellerList = () => {
            adminSellerList.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr class="border-b">
                            <th class="p-4 font-semibold text-sm text-gray-600">Nama Penjual</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Username</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sellers.map(seller => `
                            <tr class="border-b last:border-b-0 hover:bg-slate-50 transition-colors">
                                <td class="p-4">${seller.name}</td>
                                <td class="p-4 font-mono text-sm">${seller.username}</td>
                                <td class="p-4 flex gap-2">
                                    <button onclick="handleEditSeller('${seller.id}')" class="text-sm bg-yellow-500 text-white font-semibold px-3 py-1 rounded-lg hover:bg-yellow-600 transition-colors">Edit</button>
                                    <button onclick="handleDeleteSeller('${seller.id}')" class="text-sm bg-red-500 text-white font-semibold px-3 py-1 rounded-lg hover:bg-red-600 transition-colors">Hapus</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
             if (sellers.length === 0) {
                 adminSellerList.innerHTML = '<p class="text-gray-500 text-center p-4">Belum ada penjual terdaftar.</p>';
            }
        };

        const renderAdminTransactionReport = () => {
            const completedTransactions = orders.filter(o => o.status === 'Selesai');
            
            let totalRevenue = 0;
            completedTransactions.forEach(t => totalRevenue += t.total);

            adminTotalTransactions.textContent = completedTransactions.length;
            adminTotalRevenue.textContent = formatRupiah(totalRevenue);

            if (completedTransactions.length === 0) {
                adminTransactionList.innerHTML = '<p class="text-gray-500 text-center p-4">Belum ada transaksi yang selesai.</p>';
                return;
            }

            adminTransactionList.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr class="border-b">
                            <th class="p-4 font-semibold text-sm text-gray-600">ID Pesanan</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Pembeli</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Penjual</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Total</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Waktu</th>
                            <th class="p-4 font-semibold text-sm text-gray-600">Pembayaran</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${completedTransactions.sort((a,b) => b.id - a.id).map(trx => {
                            const sellerName = sellers.find(s => s.id === trx.sellerId)?.name || 'N/A';
                            return `
                            <tr class="border-b last:border-b-0 hover:bg-slate-50 transition-colors">
                                <td class="p-4 font-mono text-sm">#${trx.id}</td>
                                <td class="p-4">${trx.buyerName}</td>
                                <td class="p-4">${sellerName}</td>
                                <td class="p-4 font-semibold">${formatRupiah(trx.total)}</td>
                                <td class="p-4 text-sm">${new Date(trx.timestamp).toLocaleString('id-ID')}</td>
                                <td class="p-4 text-sm capitalize">${trx.paymentMethod}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        };
        
        const renderSellerTransactionReport = () => {
            const myCompletedTransactions = orders.filter(o => o.sellerId === currentUser.id && o.status === 'Selesai');

            if (myCompletedTransactions.length === 0) {
                sellerTransactionList.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada transaksi selesai.</p>';
                return;
            }

            sellerTransactionList.innerHTML = '';
            myCompletedTransactions.sort((a,b) => b.id - a.id).forEach(trx => {
                const trxCard = document.createElement('div');
                trxCard.className = 'border rounded-lg p-3 bg-green-50 text-sm';
                trxCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold">Pesanan #${trx.id} <span class="font-normal">oleh ${trx.buyerName}</span></p>
                            <p class="text-xs text-gray-500">${new Date(trx.timestamp).toLocaleString('id-ID')}</p>
                        </div>
                        <p class="font-semibold text-green-700">${formatRupiah(trx.total)}</p>
                    </div>
                `;
                sellerTransactionList.appendChild(trxCard);
            });
        };

        const renderAdminDashboard = () => {
            adminProductList.innerHTML = '';
            let totalSales = 0;
            orders.filter(o => o.status === 'Selesai').forEach(o => totalSales += o.total);
            const totalProfit = totalSales * 0.10;

            adminTotalSales.textContent = formatRupiah(totalSales);
            adminTotalProfit.textContent = formatRupiah(totalProfit);

            menuItems.forEach(item => {
                const productCard = document.createElement('div');
                productCard.className = 'card p-4';
                productCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-full h-32 object-cover rounded-lg mb-2">
                    <p class="font-semibold">${item.name}</p>
                    <p class="text-sm text-gray-600">${formatRupiah(item.price)}</p>
                    <p class="text-xs text-gray-500">Stok: ${item.stock}</p>
                    <p class="text-xs font-semibold text-blue-700 mt-1">Penjual: ${item.sellerName}</p>
                `;
                adminProductList.appendChild(productCard);
            });
            renderAdminSellerList();
            renderAdminUserList();
            renderAdminTransactionReport();
        };

        // --- UI Control Based on Role ---
        const updateView = () => {
            if (currentUser) {
                loginScreen.classList.add('hidden');
                registerScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                headerSubtitle.textContent = `Selamat datang, ${currentUser.name}!`;

                // Hide all role-specific sections first
                adminDashboard.classList.add('hidden');
                mainContent.classList.add('hidden');
                sellerDashboard.classList.add('hidden');
                cartAndOrdersSection.classList.add('hidden');
                addMenuButton.classList.add('hidden');

                switch (currentUser.role) {
                    case 'admin':
                        mainContent.classList.add('hidden');
                        adminDashboard.classList.remove('hidden');
                        renderAdminDashboard();
                        break;
                    case 'penjual':
                        mainContent.classList.remove('hidden');
                        sellerDashboard.classList.remove('hidden');
                        cartAndOrdersSection.classList.add('hidden');
                        addMenuButton.classList.remove('hidden');
                        menuTitle.textContent = "Produk Anda";
                        renderMenu();
                        renderSellerOrders();
                        renderSellerTransactionReport();
                        break;
                    case 'user':
                        mainContent.classList.remove('hidden');
                        sellerDashboard.classList.add('hidden');
                        cartAndOrdersSection.classList.remove('hidden');
                        menuTitle.textContent = "Menu Makanan";
                        renderMenu();
                        renderCart();
                        renderUserOrders();
                        break;
                }
            } else {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        };

        // --- AUTH LOGIC ---
        const handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const account = accounts[username];
            if (account && account.password === password) {
                currentUser = { id: account.id, username, role: account.role, name: account.name };
                loginError.textContent = '';
                document.getElementById('login-form').reset();
                updateView();
            } else {
                loginError.textContent = 'Username atau password salah.';
            }
        };

        const handleRegister = (e) => {
            e.preventDefault();
            registerError.textContent = '';
            const name = document.getElementById('register-name').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                registerError.textContent = 'Password dan konfirmasi password tidak cocok.';
                return;
            }
            if (accounts[username]) {
                registerError.textContent = 'Username sudah digunakan. Coba yang lain.';
                return;
            }

            const newUser = {
                id: 'user' + new Date().getTime(),
                name,
                username,
                password
            };
            users.push(newUser);
            generateAccounts();
            
            // Auto login after register
            const account = accounts[username];
            currentUser = { id: account.id, username, role: account.role, name: account.name };
            registerForm.reset();
            updateView();
        };

        const handleLogout = () => {
            currentUser = null;
            cart = [];
            updateView();
        };
        
        // --- CART LOGIC ---
        const addToCart = (itemId) => {
            const itemInMenu = menuItems.find(item => item.id === itemId);
            if(itemInMenu.stock <= 0) return; // double check stock

            const itemInCart = cart.find(item => item.id === itemId);
            if (itemInCart) {
                 if (itemInCart.quantity < itemInMenu.stock) {
                    itemInCart.quantity++;
                 }
            } else {
                cart.push({ ...itemInMenu, quantity: 1 });
            }
            renderCart();
        };

        const updateQuantity = (itemId, change) => {
            const itemInCart = cart.find(item => item.id === itemId);
            const itemInMenu = menuItems.find(item => item.id === itemId);

            if (itemInCart) {
                const newQuantity = itemInCart.quantity + change;
                if (newQuantity <= 0) {
                    cart = cart.filter(item => item.id !== itemId);
                } else if(newQuantity <= itemInMenu.stock) {
                    itemInCart.quantity = newQuantity;
                }
            }
            renderCart();
        };
        
        // --- ORDER LOGIC ---
        const placeOrder = () => {
            if (cart.length === 0) return;

            // Check stock availability before creating order
            let isStockSufficient = true;
            for(const cartItem of cart) {
                const menuItem = menuItems.find(item => item.id === cartItem.id);
                if (menuItem.stock < cartItem.quantity) {
                    isStockSufficient = false;
                    orderStatus.innerHTML = `<p class="text-red-600 font-semibold">Stok ${menuItem.name} tidak cukup!</p>`;
                    setTimeout(() => { orderStatus.innerHTML = ''; }, 3000);
                    break;
                }
            }
            if(!isStockSufficient) return;
            
            // Deduct stock
            cart.forEach(cartItem => {
                const menuItem = menuItems.find(item => item.id === cartItem.id);
                menuItem.stock -= cartItem.quantity;
            });

            const ordersBySeller = cart.reduce((acc, item) => {
                if (!acc[item.sellerId]) acc[item.sellerId] = [];
                acc[item.sellerId].push(item);
                return acc;
            }, {});

            for (const sellerId in ordersBySeller) {
                const sellerItems = ordersBySeller[sellerId];
                const sellerTotal = sellerItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
                orders.push({
                    id: orders.length + 1,
                    sellerId: sellerId,
                    buyerId: currentUser.id,
                    buyerName: currentUser.name,
                    items: sellerItems.map(i => ({id: i.id, name: i.name, quantity: i.quantity})),
                    total: sellerTotal,
                    status: 'Baru',
                    timestamp: new Date(),
                    paymentMethod: selectedPaymentMethod
                });
            }
            
            if(qrisMethods.includes(selectedPaymentMethod)) {
                const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                qrisTotalElement.textContent = formatRupiah(total);
                qrisModalTitle.textContent = `Pembayaran ${selectedPaymentMethod.toUpperCase()}`;
                qrisModal.classList.remove('hidden');
            } else {
                finishOrderPlacement();
            }
            renderMenu(); // Re-render menu to show updated stock
        };

        const finishOrderPlacement = () => {
            const paymentMethodText = selectedPaymentMethod.charAt(0).toUpperCase() + selectedPaymentMethod.slice(1);
            orderStatus.innerHTML = `<p class="text-green-600 font-semibold">Pesanan berhasil dengan pembayaran ${paymentMethodText}!</p>`;
            setTimeout(() => { orderStatus.innerHTML = ''; }, 3000);
            cart = [];
            renderCart();
            renderUserOrders(); // Update order history
        }

        const updateOrderStatus = (orderId, newStatus) => {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                updateView(); // Re-render everything to update all relevant views
            }
        };
        
        // --- PAYMENT LOGIC ---
        const selectPaymentMethod = (method) => {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.toggle('border-blue-600', btn.dataset.payment === method);
                btn.classList.toggle('bg-blue-50', btn.dataset.payment === method);
                btn.classList.toggle('text-blue-800', btn.dataset.payment === method);
                btn.classList.toggle('border-gray-300', btn.dataset.payment !== method);
                btn.classList.toggle('bg-white', btn.dataset.payment !== method);
                btn.classList.toggle('text-gray-800', btn.dataset.payment !== method);
            });
        };

        // --- MENU MANAGEMENT (SELLER) ---
        const openMenuModal = (item = null) => {
            menuForm.reset();
            modalError.classList.add('hidden');
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            menuImageData.value = '';

            if (item) {
                modalTitle.textContent = 'Edit Menu';
                document.getElementById('menu-id').value = item.id;
                document.getElementById('menu-name').value = item.name;
                document.getElementById('menu-price').value = item.price;
                document.getElementById('menu-stock').value = item.stock;
                menuImageData.value = item.image;
                imagePreview.src = item.image;
                imagePreview.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'Tambah Menu Baru';
                document.getElementById('menu-id').value = '';
            }
            menuModal.classList.remove('hidden');
        };
        
        const closeMenuModal = () => menuModal.classList.add('hidden');
        
        const handleSaveMenu = (e) => {
            e.preventDefault();
            modalError.classList.add('hidden');
            const id = document.getElementById('menu-id').value;
            const name = document.getElementById('menu-name').value;
            const price = parseInt(document.getElementById('menu-price').value);
            const stock = parseInt(document.getElementById('menu-stock').value);
            const image = menuImageData.value;

            if (!image) {
                modalError.textContent = 'Silakan unggah gambar makanan.';
                modalError.classList.remove('hidden');
                return;
            }

            if (id) {
                const index = menuItems.findIndex(item => item.id == id);
                if (index > -1 && menuItems[index].sellerId === currentUser.id) {
                    menuItems[index] = { ...menuItems[index], name, price, stock, image };
                }
            } else {
                const newId = menuItems.length > 0 ? Math.max(...menuItems.map(i => i.id)) + 1 : 1;
                menuItems.push({ id: newId, sellerId: currentUser.id, sellerName: currentUser.name, name, price, stock, image });
            }
            renderMenu();
            closeMenuModal();
        };
        
        const handleEditMenu = (itemId) => {
            const item = menuItems.find(i => i.id === itemId);
            if(item && item.sellerId === currentUser.id) openMenuModal(item);
        };
        
        const handleDeleteMenu = (itemId) => {
             if (confirm('Apakah Anda yakin ingin menghapus menu ini?')) {
                const item = menuItems.find(i => i.id === itemId);
                 if(item && item.sellerId === currentUser.id) {
                    menuItems = menuItems.filter(item => item.id !== itemId);
                    renderMenu();
                }
            }
        };
        
        // --- SELLER MANAGEMENT (ADMIN) ---
        const openSellerModal = (seller = null) => {
            sellerForm.reset();
            sellerModalError.classList.add('hidden');
            if (seller) {
                sellerModalTitle.textContent = 'Edit Penjual';
                document.getElementById('seller-id-input').value = seller.id;
                document.getElementById('seller-name').value = seller.name;
                document.getElementById('seller-username').value = seller.username;
                document.getElementById('seller-password').value = seller.password;
            } else {
                sellerModalTitle.textContent = 'Tambah Penjual Baru';
                document.getElementById('seller-id-input').value = '';
            }
            sellerModal.classList.remove('hidden');
        };

        const closeSellerModal = () => sellerModal.classList.add('hidden');

        const handleSaveSeller = (e) => {
            e.preventDefault();
            sellerModalError.classList.add('hidden');
            const id = document.getElementById('seller-id-input').value;
            const name = document.getElementById('seller-name').value;
            const username = document.getElementById('seller-username').value;
            const password = document.getElementById('seller-password').value;

            const usernameExists = sellers.some(s => s.username === username && s.id !== id);
            if (usernameExists) {
                sellerModalError.textContent = 'Username sudah digunakan. Coba yang lain.';
                sellerModalError.classList.remove('hidden');
                return;
            }

            if (id) { // Edit
                const index = sellers.findIndex(s => s.id === id);
                if (index > -1) {
                    sellers[index] = { ...sellers[index], name, username, password };
                }
            } else { // Add
                const newId = 'seller' + new Date().getTime();
                sellers.push({ id: newId, name, username, password });
            }
            generateAccounts();
            renderAdminDashboard();
            closeSellerModal();
        };

        const handleEditSeller = (sellerId) => {
            const seller = sellers.find(s => s.id === sellerId);
            if (seller) openSellerModal(seller);
        };
        
        const handleDeleteSeller = (sellerId) => {
            if (confirm('Menghapus penjual juga akan menghapus SEMUA produk mereka. Anda yakin?')) {
                sellers = sellers.filter(s => s.id !== sellerId);
                menuItems = menuItems.filter(item => item.sellerId !== sellerId);
                generateAccounts();
                renderAdminDashboard();
            }
        };

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            generateAccounts();

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutButton.addEventListener('click', handleLogout);
            orderButton.addEventListener('click', placeOrder);
            
            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginScreen.classList.add('hidden');
                registerScreen.classList.remove('hidden');
                loginForm.reset();
                loginError.textContent = '';
            });
            
            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                registerForm.reset();
                registerError.textContent = '';
            });

            addMenuButton.addEventListener('click', () => openMenuModal());
            cancelModalButton.addEventListener('click', closeMenuModal);
            menuForm.addEventListener('submit', handleSaveMenu);
            
            addSellerButton.addEventListener('click', () => openSellerModal());
            cancelSellerModalButton.addEventListener('click', closeSellerModal);
            sellerForm.addEventListener('submit', handleSaveSeller);
            
            menuImageUpload.addEventListener('change', () => {
                const file = menuImageUpload.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        menuImageData.value = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            paymentMethodsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.payment-method-btn');
                if (button) {
                    selectPaymentMethod(button.dataset.payment);
                }
            });
            
            closeQrisModalButton.addEventListener('click', () => {
                qrisModal.classList.add('hidden');
                finishOrderPlacement();
            });
            
            updateView(); // Initial call
        });
    </script>
</body>
</html>
